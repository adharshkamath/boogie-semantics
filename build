#!/usr/bin/env python3

import os
import subprocess
import sys

# Bootstrapping
# =============

# Make sure the KNinja repo is available.
#
subprocess.check_call(['git', 'submodule', 'update', '--init', '--recursive'])
extdir = 'ext'
sys.path.append(os.path.join(os.path.dirname(__file__), extdir))

from kninja import *

# Build
# =====

proj = KProject(extdir = extdir)
boogie = proj.definition( alias         = 'boogie'
                        , backend       = 'haskell'
                        , main          = 'boogie.md'
                        , other         = ['syntax.md']
                        , runner_script = './boogie'
                        )

# Parsing tests
# =============

# TODO: A DSL for this should be provide by KNinja
tests = []
# our own tests to get us started, simpler than the Boogie test suite
tests += [proj.source(test).then(boogie.kast()) for test in glob('./test/**/*.bpl')]
# start with just test- prefixed directories for now, worry about the others later
tests += [proj.source(test).then(boogie.kast()) 
            for test in glob('ext/boogie/Test/test*/*.bpl')]

proj.alias('parse-tests', tests).default()
 
# Main
# ====

proj.main()
