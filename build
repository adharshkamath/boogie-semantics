#!/usr/bin/env python3

import os
import subprocess
import sys

# Bootstrapping
# =============

# Make sure the KNinja repo is available.
#
subprocess.check_call(['git', 'submodule', 'update', '--init', '--recursive'])
extdir = 'ext'
sys.path.append(os.path.join(os.path.dirname(__file__), extdir))

from kninja import *

# Build
# =====

proj = KProject(extdir = extdir)
boogie = proj.definition( alias         = 'boogie'
                        , main          = 'boogie.md'
                        , other         = ['syntax.md']
                        , backend       = 'haskell'
                        , flags         = '--syntax-module BOOGIE-PROGRAM-SYNTAX'
                        , runner_script = './boogie'
                        )

# Parsing tests
# =============

# parse_tests = []
# parse_tests += [proj.source(test).then(boogie.kast()) for test in glob('ext/boogie/Test/test*/*.bpl')]
# proj.alias('parse-tests', parse_tests).default()
 
exec_tests = []
# Our own tests to get us started, simpler than the Boogie test suite
exec_tests += [proj.source(test).then(boogie.krun().variable('flags', '--search-final')) for test in glob('./test/**/*.bpl')]
proj.alias('exec-tests', exec_tests).default()
 
# Main
# ====

proj.main()
